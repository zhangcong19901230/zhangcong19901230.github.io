<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>导航</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { height: 500px}
        .mapboxgl-ctrl-bottom-left{
            display: none;
        }
        .mapboxgl-ctrl-attrib-inner{
            display: none;
        }
        .mapboxgl-canvas{
            background: rgb(1 255 114 / 10%);
        }
    </style>
    <script src="jquery.min.js"></script>
</head>
<body>
<div id='map'></div>
<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoiemhhbmdjb25nMTk5MDEyMzAiLCJhIjoiY2p5aWJ2a3RlMDh0YjNjangxYmI5cXViMSJ9.RkyTKOoRzQfoXAqs3GamLA';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v10',
        center: [111.041, 34.9739],
        zoom: 15.7,
        pitch: 10,
        bearing: 160
    });

    map.on('load', function () {
        map.on('click', (e) => {
            let existLayersIds = []
            console.log(` ${e.lngLat}`);
            const bbox = [
                [e.point.x - 5, e.point.y - 5],
                [e.point.x + 5, e.point.y + 5]
            ];
            const existLayers = map.getStyle().layers;
            existLayers.forEach(existLayer => {
                const existLayerId = existLayer.id;
                if (existLayerId.includes('poiLayerId')) {
                    existLayersIds.push(existLayer.id);
                }
            });
            let renderFeatures = map.queryRenderedFeatures(bbox, { layers: existLayersIds });
            renderFeatures.forEach(renderFeature => {
                let name = renderFeature.properties.title
                endCoor = renderFeature.geometry.coordinates
                alert(name)
            })
        });
        addMarker()
    })
    function addMarker() {
        map.loadImage('poi.png', function(error, image) {
            if (error) throw error;
            map.addImage('poi', image);
            map.addSource('poiSource',{
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": [
                       {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [111.041, 34.9739]
                        },
                       'properties': {
                           'title': '电动门'
                       }
                       },
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [111.041, 34.971]
                            },
                            'properties': {
                                'title': '综合楼'
                            }
                        }
                    ]
                }
            })
            map.addLayer({
                "id": "poiLayerId",
                "type": "symbol",
                "source":'poiSource',
                "layout": {
                   /* 'text-field': ['title'],
                    'text-font': [
                        'Open Sans Semibold',
                        'Arial Unicode MS Bold'
                    ],
                    'text-offset': [0, 1.25],
                    'text-anchor': 'top',*/
                    "icon-image": "poi",
                    "icon-size": 0.43,
                    "icon-rotate":0,
                    "icon-ignore-placement": true
                }
            });
        })
    }
</script>

</body>
</html>
