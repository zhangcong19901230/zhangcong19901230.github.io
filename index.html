<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>导航</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { height: 500px}
        .mapboxgl-ctrl-bottom-left{
            display: none;
        }
        .mapboxgl-ctrl-attrib-inner{
            display: none;
        }
        .mapboxgl-canvas{
            background: rgb(1 255 114 / 10%);
        }
        .mapboxgl-ctrl-bottom-right{
            display: none;
        }
    </style>
    <script src="jquery.min.js"></script>
    <script type="text/javascript" src="https://js.cdn.aliyun.dcloud.net.cn/dev/uni-app/uni.webview.1.5.2.js"></script>
</head>
<body>
<div id='map'></div>
<script>
    document.addEventListener('UniAppJSBridgeReady', function() {
        uni.postMessage({
            data: {
                action: '这是我传送的消息'
            }
        });//传递的消息信息，必须写在 data 对象中。
    });
    mapboxgl.accessToken = 'pk.eyJ1Ijoiemhhbmdjb25nMTk5MDEyMzAiLCJhIjoiY2p5aWJ2a3RlMDh0YjNjangxYmI5cXViMSJ9.RkyTKOoRzQfoXAqs3GamLA';
    //天地图（各个区域的token可以在网上查到）
     var vecUrl = "http://t0.tianditu.com/vec_w/wmts?tk=e90d56e5a09d1767899ad45846b0cefd";
     var cvaUrl = "http://t0.tianditu.com/cva_w/wmts?tk=e90d56e5a09d1767899ad45846b0cefd";
     //使用严格模式
     "use strict";
     //实例化source对象
     var tdtVec = {
             "type": "raster",
             'tiles': [
                 vecUrl + "&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=tiles"
              ],
             'tileSize': 256
     };
     var tdtCva = {
             "type": "raster",
             'tiles': [
                  cvaUrl + "&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=tiles"
              ],
             'tileSize': 256
     };
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v11',
  /*      style: {
                "version": 8,
                "sources": {
                "tdtVec": tdtVec,
                "tdtCva": tdtCva
        },
        "layers": [
                 {
                     "id": "tdtVec",
                     "type": "raster",
                     "source": "tdtVec",
                     "minzoom": 0,
                     "maxzoom": 22
                    },
                 {
                      "id": "tdtCva",
                     "type": "raster",
                     "source": "tdtCva",
                     "minzoom": 0,
                     "maxzoom": 22
             }
        ],
    },*/
        center: [117.07822, 32.16236],
        zoom: 15.7,
        pitch: 10,
        bearing: 0
    });

    map.on('load', function () {
        map.on('click', (e) => {
            uni.postMessage({
                data: {
                    action: '息'
                }
            });
            uni.getLocation({
                success: res => {
                    console.log('location success', res)
                    uni.openLocation({
                        latitude: 32.16236,
                        longitude: 117.07822,
                        scale: 18
                    })
                }
            })
            let existLayersIds = []
            console.log(` ${e.lngLat}`);
            const bbox = [
                [e.point.x - 5, e.point.y - 5],
                [e.point.x + 5, e.point.y + 5]
            ];
            const existLayers = map.getStyle().layers;
            existLayers.forEach(existLayer => {
                const existLayerId = existLayer.id;
                if (existLayerId.includes('poiLayerId')) {
                    existLayersIds.push(existLayer.id);
                }
            });
            let renderFeatures = map.queryRenderedFeatures(bbox, { layers: existLayersIds });
            renderFeatures.forEach(renderFeature => {
                let name = renderFeature.properties.title
                endCoor = renderFeature.geometry.coordinates
                alert(name)
            })
        });
        addMarker()
        addPolygon()
    })
    function addMarker() {
        map.loadImage('poi.png', function(error, image) {
            if (error) throw error;
            map.addImage('poi', image);
            map.addSource('poiSource',{
                "type": "geojson",
                "data": "frampoi.json"
            })
            map.addLayer({
                "id": "poiLayerId",
                "type": "symbol",
                "source":'poiSource',
                "layout": {
                   /* 'text-field': ['title'],
                    'text-font': [
                        'Open Sans Semibold',
                        'Arial Unicode MS Bold'
                    ],
                    'text-offset': [0, 1.25],
                    'text-anchor': 'top',*/
                    "icon-image": "poi",
                    "icon-size": 0.43,
                    "icon-rotate":0,
                    "icon-ignore-placement": true
                }
            });
        })
    }
    function addPolygon() {
        map.addSource('farmSource',{
            "type": "geojson",
            "data": "farm.json"
        })
        map.addLayer({
            "id": "farm",
            "type": "fill-extrusion",
            "source":'farmSource',
            "paint":{
                'fill-extrusion-color': ['get', 'color'],
                 'fill-extrusion-opacity':0.3
                //'fill-color':'red',
                //'fill-opacity':0.3
            }
        });


    }
</script>

</body>
</html>
