<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>导航</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        .infoBox{
            position: absolute;
            left: 5%;
            top: 2%;
            color: #fffdfb;
            background: rgba(2, 138, 255, 0.5);
            display: flex;
            height: 9%;
            flex-direction: column;
            width: 88%;
            padding: 1%;
            font-size: medium;
        }
        .infoBoxList{
            position: absolute;
            left: 22%;
            bottom: 1%;
            color: #0e0201;
            background: rgba(91, 166, 255, 0.8);
            height: 10%;
            width: 48%;
            padding: 1%;
            overflow-y: scroll;
            font-size: 5px;
        }
        .mapboxgl-ctrl-bottom-left{
            display: none;
        }
        .mapboxgl-canvas{
            background: rgb(1 255 114 / 19%);
        }
    </style>
    <script src="jquery.min.js"></script>
</head>
<body>
<div id='map'></div>
<div class="infoBox">
    <div>
        <span>起点： </span>
        <input id="startPoint" placeholder="默认起点大门口"></input>
    </div>
    <div>
        <span>终点： </span>
        <input id="endPoint" placeholder="请点击选择终点"></input>
        <button style="background: #28ec10a6;
    top: 23%;
    position: absolute;
    right: 1%;
    width: 21%;
    height: 52%;" onclick="goTo()">导航</button>
    </div>
</div>
<div style="position: absolute;bottom:17%;right: -2%" onclick="goPosition()">
    <img  height="60" width="60" src="goposition.png">
</div>
<div class="infoBoxList" id="infoBoxList">
    <div style="color: #fffdfb;background: rgba(27,255,49,0.46);text-align: center;font-size: 16px">线路详情</div>
</div>
<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoiemhhbmdjb25nMTk5MDEyMzAiLCJhIjoiY2p5aWJ2a3RlMDh0YjNjangxYmI5cXViMSJ9.RkyTKOoRzQfoXAqs3GamLA';
    var map = new mapboxgl.Map({
        container: 'map',
        ///style: 'mapbox://styles/mapbox/dark-v10',
        style: {
            "version": 8,
            "name": "Mapbox Streets",
            "sources": {
                "osm-tiles": {
                    'type': 'raster',
                    'tiles': ['http://101.42.135.235:6080/arcgis/rest/services/YCIMGNEW/MapServer/WMTS/tile/1.0.0/YCIMGNEW/default/default028mm/{z}/{y}/{x}.png'],
                    'tileSize': 256,
                    "bounds": [-180, -90, 180, 90]
                }
            },
            "layers":[{
                "id": "123",
                "type": "raster",
                "source": "osm-tiles",
                "source-layer": "osmtiles"
            }]
        },
        center: [111.041, 34.9739],
        zoom: 15.7,
        pitch: 10,
        bearing: 160
    });

    map.on('load', function () {
        map.on('click', (e) => {
            let existLayersIds = []
            console.log(` ${e.lngLat}`);
            const bbox = [
                [e.point.x - 5, e.point.y - 5],
                [e.point.x + 5, e.point.y + 5]
            ];
            const existLayers = map.getStyle().layers;
            existLayers.forEach(existLayer => {
                const existLayerId = existLayer.id;
                if (existLayerId.includes('poilayerId')) {
                    existLayersIds.push(existLayer.id);
                }
            });
            let renderFeatures = map.queryRenderedFeatures(bbox, { layers: existLayersIds });
            renderFeatures.forEach(renderFeature => {
                let name = renderFeature.properties.title
                endCoor = renderFeature.geometry.coordinates
                $("#endPoint").val(name)
            })
        });
        addMarker()
    })
    let curTimePosition = []
    let startCoor = [111.03943,34.975025]
    let endCoor = []
    let path = []
    let curBear = 0;
    function ajax() {
        $.ajax({
            url:'http://101.42.135.235:6080/arcgis/rest/services/roadnet/NAServer/%E8%B7%AF%E5%BE%84/solve?f=pjson&stops='+startCoor[0]+','+startCoor[1]+';'+endCoor[0]+','+endCoor[1]+'&returnDirections=true&directionsOutputType=esriDOTComplete&directionsLengthUnits=esriNAUKilometers',
            async:true,
            data:{},
            success:function(data){
                path = []
                document.getElementById('infoBoxList').innerHTML = '';
                JSON.parse(data).directions[0].features.forEach(function (val) {
                    $('.infoBoxList').append("<div>"+val.attributes.text+"</div>")
                })
                JSON.parse(data).routes.features[0].geometry.paths[0].forEach(function (val) {
                    path.push([val[0],val[1]])
                })
                addRoad(path)
            },
            error:function (e) {
                alert("请求失败");
            }
        })
    }

    function addMarker() {
        map.loadImage('poi.png', function(error, image) {
            if (error) throw error;
            map.addImage('poi', image);
            map.addSource('poiSource',{
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": [
                       {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [111.0396267, 34.974615]
                        },
                       'properties': {
                           'title': '电动门'
                       }
                       },
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [111.0392225, 34.9740575]
                            },
                            'properties': {
                                'title': '综合楼'
                            }
                        },
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [111.0408567, 34.97405333]
                            },
                            'properties': {
                                'title': '小车1号二级待考室'
                            }
                        },
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [111.0415233, 34.97427]
                            },
                            'properties': {
                                'title': '小车2号二级待考室'
                            }
                        },
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [111.0422, 34.974516]
                            },
                            'properties': {
                                'title': '小车3号二级待考室'
                            }
                        },
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [111.0428717, 34.97477167]
                            },
                            'properties': {
                                'title': '小车4号二级待考室'
                            }
                        },
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [111.0396183, 34.97360167]
                            },
                            'properties': {
                                'title': '大车二级待考室'
                            }
                        },
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [111.03943, 34.975025]
                            },
                            'properties': {
                                'title': '大门口'
                            }
                        }
                    ]
                }
            })
            map.addLayer({
                "id": "poilayerId",
                "type": "symbol",
                "source":'poiSource',
                "layout": {
                   /* 'text-field': ['title'],
                    'text-font': [
                        'Open Sans Semibold',
                        'Arial Unicode MS Bold'
                    ],
                    'text-offset': [0, 1.25],
                    'text-anchor': 'top',*/
                    "icon-image": "poi",
                    "icon-size": 0.43,
                    "icon-rotate":0,
                    "icon-ignore-placement": true
                }
            });
        })
    }
    function addRoad(coordinates){
        if(map.getSource('startSource')){
            map.removeLayer('startLayerId')
            map.removeSource('startSource')
            map.removeLayer('endLayerId')
            map.removeSource('endSource')
            map.removeImage('start')
            map.removeImage('end')
        }
        map.loadImage('start.png', function(error, image) {
            if (error) throw error;
            map.addImage('start', image);
            map.addSource('startSource',{
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": [
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates":[path[0][0], path[0][1]]
                            }
                        }
                    ]
                }
            })
            map.addLayer({
                "id": "startLayerId",
                "type": "symbol",
                "source":'startSource',
                "layout": {
                    "icon-image": "start",
                    "icon-size": 0,
                    "icon-rotate":0,
                    "icon-ignore-placement": true
                }
            });
        })
        map.loadImage('end.png', function(error, image) {
            if (error) throw error;
            map.addImage('end', image);
            map.addSource('endSource',{
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": [
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [path[path.length-1][0], path[path.length-1][1]]
                            }
                        }
                    ]
                }
            })
            map.addLayer({
                "id": "endLayerId",
                "type": "symbol",
                "source":'endSource',
                "layout": {
                    "icon-image": "end",
                    "icon-size": 0.65,
                    "icon-rotate":0,
                    "icon-ignore-placement": true
                }
            });
        })
        if(map.getSource('lineSource')){
            map.removeLayer('line')
            map.removeSource('lineSource')
        }
        var geojson = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "coordinates": coordinates,
                    "type": "LineString"
                }
            }]
        };
        map.addSource('lineSource', {
            type: 'geojson',
            lineMetrics: true,
            data: geojson
        });
        map.addLayer({
            type: 'line',
            source: 'lineSource',
            id: 'line',
            paint: {
                'line-color': '#17ff71',
                'line-width': 8
            },
            layout: {
                'line-cap': 'round',
                'line-join': 'round'
            }
        });
    }

    function getPosition(){
        if(window.navigator.geolocation){
            navigator.geolocation.watchPosition(showPosition,errobak,{provider:'system',coordsType: 'wgs84',enableHighAccuracy:true,timeout:5000,maximumAge:20000});
        }else{
            alert("定位不支持")
        }
        window.addEventListener('deviceorientation', function(e){
            curBear=e.alpha
            if(map.hasImage('position')){
                map.setLayoutProperty('points', 'icon-rotate', curBear + 160);
            }
        }, false);
    }
    function errobak() {
        alert("GPS信号差");
    }
    function showPosition(position)//偏移修改
    {
        var latitude = position.coords.latitude + 3.0049250000000036;
        var longitude = position.coords.longitude - 6.22487000000001;
        setPosition(longitude,latitude)
        startCoor = [longitude,latitude]
        curTimePosition = [longitude,latitude]
    }
    function setPosition(longitude,latitude){
        //alert("经度："+longitude + "||纬度："+latitude)
        map.setCenter([longitude, latitude]);
        let positionSource = map.getSource('positionSource')
        if(positionSource){
            positionSource.setData({
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "properties": {"name": "Null Island"},
                    "geometry": {
                        "type": "Point",
                        "coordinates": [ longitude, latitude ]
                    }
                }]
            });
            return
        }
        map.loadImage('curposition.png', function(error, image) {
            if (error) throw error;
            map.addImage('position', image);
            map.addSource('positionSource',{
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": [{
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [117.2035, 31.8422827574]
                        }
                    }]
                }

            })
            map.addLayer({
                "id": "points",
                "type": "symbol",
                "source":'positionSource',
                "layout": {
                    "icon-image": "position",
                    "icon-size": 0.7,
                    "icon-rotate":0,
                    "icon-ignore-placement": true
                }
            },'poilayerId');
        })
    }


    function addOutRoad(coordinates){
        if(map.getSource('outLineSource')){
            map.removeLayer('outLine')
            map.removeSource('outLineSource')
        }
        var geojson = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "coordinates": coordinates,
                    "type": "LineString"
                }
            }]
        };
        map.addSource('outLineSource', {
            type: 'geojson',
            lineMetrics: true,
            data: geojson
        });
        map.addLayer({
            type: 'line',
            source: 'outLineSource',
            id: 'outLine',
            paint: {
                'line-color': '#2b3859',
                'line-width': 8
            },
            layout: {
                'line-cap': 'round',
                'line-join': 'round'
            }
        },'line');
    }
    var outPath = []
    function addOutRoadAjax() {
        $.ajax({
            url:'http://101.42.135.235:6080/arcgis/rest/services/roadnet/NAServer/%E8%B7%AF%E5%BE%84/solve?f=pjson&stops='+path[0][0]+','+path[0][1]+';'+curTimePosition[0]+','+curTimePosition[1]+'&returnDirections=true&directionsOutputType=esriDOTComplete&directionsLengthUnits=esriNAUKilometers',
            async:true,
            data:{},
            success:function(data){
                outPath = []
                JSON.parse(data).routes.features[0].geometry.paths[0].forEach(function (val) {
                    outPath.push([val[0],val[1]])
                })
                addOutRoad(outPath)
            },
            error:function (e) {
                alert("请求失败");
            }
        })
    }
    setInterval(function () {
        //偏移修改
        curTimePosition  =  [111.0392225, 34.9740575]
        if(path.length>0 && curTimePosition.length>0){
            addOutRoadAjax()
        }
    },3000)

    function goTo(){
        ajax()
    }
    function goPosition(){
        getPosition()
    }
</script>

</body>
</html>
